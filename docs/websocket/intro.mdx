---
title: "Real‑time WebSocket API"
description: "Stream prices and account updates over a single multiplexed socket."
---

## Endpoint

| URL                          | Notes                                                                    |
| ---------------------------- | ------------------------------------------------------------------------ |
| **`wss://ws.pfex.io/v4/ws`** | One socket. All channels (BBO, orders, balances …) are multiplexed here. |

---

## Channels

| Channel        | `id` example     | gRPC upstream                        |
| -------------- | ---------------- | ------------------------------------ |
| `v4_bbo`       | `bbo`            | `MarketDataService.GetBbo`           |
| `v4_orderbook` | `AAPL-USD`       | `MarketDataService.GetOrderBook`     |
| `v4_trades`    | `AAPL-USD`       | `MarketDataService.GetTrades`        |
| `v4_candles`   | `AAPL-USD/1MIN`  | `MarketDataService.GetLatestCandle`  |
| `v4_orders`    | **your API key** | `PortService.StreamOrders` _(bi‑di)_ |
| `v4_balances`  | **your API key** | `PortService.GetUserBalance`         |
| `v4_positions` | **your API key** | `PortService.GetUserPositions`       |
| `v4_pnl`       | _none_           | `PortService.PnlLeaderboard`         |

> **Auth** &nbsp;Channels with private data (`orders`, `balances`, `positions`) require
> `id = <API key>` obtained from **app.pfex.io › Settings › API keys**.

---

## Message flow

```json title="Subscribe"
{
  "type": "subscribe",
  "channel": "v4_bbo",
  "id": "bbo"
}
```

```json title="Server ack"
{
  "type": "subscribed",
  "connection_id": "9dd1…",
  "message_id": 1,
  "channel": "v4_bbo",
  "id": "bbo",
  "version": "2.1.0",
  "contents": {
    "bbo": [{ "symbol": "AAPL-USD", "bidPrice": "208.5", "askPrice": "208.6" }]
  }
}
```

Subsequent pushes use `type: "channel_batch_data"` with incremental `message_id`.

### Place a LIMIT order

```json title="Add order"
{
  "channel": "v4_orders",
  "id": "<YOUR_API_KEY>",
  "order": {
    "action": "ADD",
    "marketId": "AAPL-USD",
    "side": "BUY",
    "type": "LIMIT",
    "timeInForce": "GFD",
    "size": "0.10",
    "price": "210.00"
  }
}
```

Cancel:

```json title="Cancel order"
{
  "channel": "v4_orders",
  "id": "<YOUR_API_KEY>",
  "order": {
    "action": "CANCEL",
    "marketId": "AAPL-USD",
    "orderId": "123‑abc"
  }
}
```

---

## Quick‑start client

<Tabs group="lang">
  <Tab label="Python (asyncio)">

```python
import asyncio, json, websockets, os

WS_URL = "wss://ws.pfex.io/v4/ws"
API_KEY = os.getenv("PFEX_API_KEY")

async def main():
    async with websockets.connect(WS_URL, ping_interval=20) as ws:
        # connected msg
        print(json.loads(await ws.recv()))

        # subscribe to public BBO
        await ws.send(json.dumps({
            "type": "subscribe", "channel": "v4_bbo", "id": "bbo"
        }))

        # subscribe to your balances
        await ws.send(json.dumps({
            "type": "subscribe", "channel": "v4_balances", "id": API_KEY
        }))

        while True:
            msg = json.loads(await ws.recv())
            if msg["channel"] == "v4_bbo":
                print("BBO", msg["contents"][0])
            elif msg["channel"] == "v4_balances":
                print("Balance", msg["contents"][0])

asyncio.run(main())
```

  </Tab>
  <Tab label="JavaScript">

```js
import WebSocket from "isomorphic-ws";

const ws = new WebSocket("wss://ws.pfex.io/v4/ws");

ws.onopen = () => {
  ws.send(JSON.stringify({ type: "subscribe", channel: "v4_bbo", id: "bbo" }));
};

ws.onmessage = (ev) => {
  const msg = JSON.parse(ev.data);
  if (msg.channel === "v4_bbo") {
    console.log("BBO", msg.contents[0]);
  }
};
```

  </Tab>
</Tabs>

---

## Error codes & reconnects

| Scenario         | Error                                    | Action                                      |
| ---------------- | ---------------------------------------- | ------------------------------------------- |
| Invalid API key  | `Error in order stream: UNAUTHENTICATED` | Verify key in **Settings › API keys**       |
| Socket closed    | `RuntimeError: WebSocket is closed`      | Reconnect & re‑subscribe (server stateless) |
| Snapshot timeout | `type: "error"` envelope                 | Retry with back‑off; check symbol spelling  |

---
